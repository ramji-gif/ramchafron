<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swadeshi Voice Translator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: linear-gradient(-45deg, #1e3c72, #2a5298, #6dd5ed, #2193b0);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-radius: 16px;
      padding: 40px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      text-align: center;
      color: #fff;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    label {
      margin-top: 15px;
      font-size: 14px;
      display: block;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    select, button, input, textarea {
      padding: 12px 16px;
      margin: 10px 5px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      min-width: 180px;
    }

    select, input, textarea {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      outline: none;
    }

    input::placeholder, textarea::placeholder {
      color: #ccc;
    }

    select option {
      color: #000;
    }

    button {
      background-color: #00c6ff;
      color: white;
      font-weight: bold;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background-color: #0072ff;
    }

    audio {
      margin-top: 30px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>üåê Swadeshi Voice Translator</h2>

    <label for="deviceId">Device ID (e.g. device1, device2)</label>
    <input type="text" id="deviceId" placeholder="Enter your device ID" />

    <label for="srcLang">From Language</label>
    <select id="srcLang"></select>

    <label for="tgtLang">To Language</label>
    <select id="tgtLang"></select>

    <div>
      <button id="connectBtn">üîó Connect</button>
      <button id="speakBtn" disabled>üé§ Speak</button>
    </div>

    <div>
      <label for="textInput">Enter Text for Translation</label>
      <input type="text" id="textInput" placeholder="Enter text" />
      <button id="translateBtn">Translate Text</button>
      <p>Translated Text: </p>
      <textarea id="translatedTextField" rows="4" readonly></textarea> <!-- New field for translated text -->
      <!-- Add a button to speak translated text -->
      <button id="speakTranslatedBtn" disabled>üîä Speak Translated Text</button>
    </div>

    <audio id="audioPlayer" controls></audio>
  </div>

  <script>
    const langs = [
      "Assamese", "Bengali", "Bodo", "Dogri", "Gujarati", "Hindi", "Kannada", "Kashmiri",
      "Konkani", "Maithili", "Malayalam", "Manipuri", "Marathi", "Odia", "Punjabi",
      "Sanskrit", "Santhali", "Sindhi", "Tamil", "Telugu", "Urdu", "English",
      "Bhojpuri", "Chhattisgarhi", "Rajasthani"
    ];

    const src = document.getElementById("srcLang");
    const tgt = document.getElementById("tgtLang");
    const deviceInput = document.getElementById("deviceId");
    const connectBtn = document.getElementById("connectBtn");
    const speakBtn = document.getElementById("speakBtn");
    const audioPlayer = document.getElementById("audioPlayer");
    const textInput = document.getElementById("textInput");
    const translateBtn = document.getElementById("translateBtn");
    const translatedTextField = document.getElementById("translatedTextField");
    const speakTranslatedBtn = document.getElementById("speakTranslatedBtn");

    langs.forEach(lang => {
      src.add(new Option(lang, lang));
      tgt.add(new Option(lang, lang));
    });

    let ws;

    connectBtn.onclick = () => {
      const s = src.value;
      const t = tgt.value;
      const deviceId = deviceInput.value.trim();

      if (!s || !t || !deviceId) {
        alert("Please select both languages and enter your device ID.");
        return;
      }

      console.log(`üîó Connecting as ${deviceId} (${s} ‚Üí ${t})`);
      ws = new WebSocket(`wss://voice-translator-backend-2d4s.onrender.com/ws/${s}/${t}/${deviceId}`);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        console.log("‚úÖ WebSocket connected");
        speakBtn.disabled = false;
      };

      ws.onmessage = e => {
        if (typeof e.data !== "string") {
          console.log("üîä Received translated audio");
          const audioBlob = new Blob([e.data], { type: "audio/mp3" });
          audioPlayer.src = URL.createObjectURL(audioBlob);
          audioPlayer.play();
        } else {
          console.log("‚ÑπÔ∏è Message:", e.data);
        }
      };

      ws.onerror = err => {
        console.error("‚ùå WebSocket error:", err);
      };

      ws.onclose = () => {
        console.log("üîå WebSocket closed");
        speakBtn.disabled = true;
      };
    };

    translateBtn.onclick = async () => {
      const text = textInput.value.trim();
      if (!text) {
        alert("Please enter text for translation.");
        return;
      }

      const srcLang = src.value;
      const tgtLang = tgt.value;

      try {
        const response = await fetch("https://voice-translator-backend-2d4s.onrender.com/translate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ src: srcLang, tgt: tgtLang, text: text })
        });
        const result = await response.json();
        translatedTextField.textContent = result.translated_text || result.error;
        
        // Enable the "Speak Translated Text" button once translation is done
        speakTranslatedBtn.disabled = false;

      } catch (error) {
        console.error("Error during translation:", error);
        translatedTextField.textContent = "Error during translation";
      }
    };

    speakTranslatedBtn.onclick = async () => {
      const translated = translatedTextField.value.trim();
      if (!translated) {
        alert("No translated text to speak.");
        return;
      }

      const language = tgt.value.toLowerCase(); // Use target language for TTS

      // Using the Google Text-to-Speech API via the `gTTS` package
      const audioUrl = await fetch(`https://translate.google.com/translate_tts?ie=UTF-8&q=${translated}&tl=${language}&client=tw-ob`)
        .then(response => response.blob())
        .then(blob => URL.createObjectURL(blob));

      const audio = new Audio(audioUrl);
      audio.play();
    };
  </script>
</body>
</html>
